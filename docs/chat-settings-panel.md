# 对话设置面板设计文档

## 1. 概述

对话设置面板是Maestro聊天应用的一个核心功能，它允许用户在聊天界面中直接配置当前对话的各种参数，包括使用的AI模型、系统提示词和对话轮数限制等。该面板采用侧边滑入的设计，与主内容区共存于同一页面。

## 2. 设计原则

- **无缝集成**：设置面板从右侧滑入，推移主内容区，保持内容的可见性和上下文
- **即时配置**：用户可以随时调整当前对话的设置，无需离开对话界面
- **响应式布局**：根据不同屏幕尺寸调整面板宽度和交互方式
- **优雅过渡**：平滑的动画效果，增强用户体验
- **层级管理**：精心设计的z-index层级管理，确保界面元素正确叠放

## 3. 功能需求

### 3.1 核心功能

- **模型选择**：
  - 提供可搜索的下拉框
  - 仅显示已配置API密钥的供应商和模型
  - 按供应商分组展示模型

- **系统提示词**：
  - 多行文本输入
  - 字数限制和计数器
  - 可能支持格式化和模板

- **对话轮数限制**：
  - 设置保留的最近对话轮数
  - 通过滑块或数字输入控制
  - 提供合理的默认值和范围(如2-50轮)

### 3.2 界面交互

- **打开/关闭机制**：
  - 点击聊天头部的设置按钮打开
  - 点击关闭按钮关闭（现在集成在header中）
  - 支持Esc键关闭

- **操作按钮**：
  - 保存按钮：应用设置更改
  - 恢复默认按钮：重置为全局默认设置

## 4. 技术实现

### 4.1 组件结构

```
ChatContainer
├── ChatHeader (包含设置按钮和关闭按钮)
├── MainContentArea (推移动画)
│   ├── MessageList
│   └── ChatInput
└── ChatSettingsPanel (滑入动画)
    ├── PanelHeader
    ├── SettingsContent
    │   ├── ModelSelector
    │   ├── SystemPromptInput
    │   └── MaxTurnsSlider
    └── ActionButtons
```

### 4.2 状态管理扩展

需要在现有的聊天状态存储中添加新的属性和方法：

```typescript
// 扩展Conversation接口
interface Conversation {
  // 现有字段...
  
  // 新增字段
  systemPrompt?: string;
  maxTurns?: number;
}

// 添加更新设置的方法
interface ChatState {
  // 现有方法...
  
  // 新增方法
  updateConversationSettings: (
    conversationId: string, 
    settings: {
      modelId?: string;
      providerId?: string;
      systemPrompt?: string;
      maxTurns?: number;
    }
  ) => void;
}
```

### 4.3 关键组件实现

#### 设置面板容器

```typescript
function ChatSettingsPanel({
  isOpen,
  onClose
}: {
  isOpen: boolean;
  onClose: () => void;
}) {
  // 设置面板实现...
}
```

#### 模型选择组件

```typescript
function ModelSelector({
  value,
  onChange,
  showOnlyConfigured = true,
  searchable = true
}: {
  value: string;
  onChange: (value: string) => void;
  showOnlyConfigured?: boolean;
  searchable?: boolean;
}) {
  // 模型选择器实现...
}
```

## 5. 用户界面设计

### 5.1 布局结构

```
+-------------------------------------------------------------+
|                                                             |
| +-----------------聊天头部(通用)-----------------------+    |
| | Maestro                           设置/关闭按钮      |    |
| +----------------------------------+ +-------------------+  |
| |                                  | |                   |  |
| |                                  | |  对话设置         |  |
| |                                  | |-------------------|  |
| |                                  | |                   |  |
| |                                  | |  模型             |  |
| |       聊天主内容区               | |  +------------+   |  |
| |       向左推移                   | |  | 选择模型 v |   |  |
| |                                  | |  +------------+   |  |
| |                                  | |                   |  |
| |                                  | |  系统提示词       |  |
| |                                  | |  +------------+   |  |
| |                                  | |  |            |   |  |
| |                                  | |  |            |   |  |
| |                                  | |  |            |   |  |
| |                                  | |  +------------+   |  |
| |                                  | |  0/4000           |  |
| |                                  | |                   |  |
| |                                  | |  保留对话轮数     |  |
| |                                  | |  +------------+   |  |
| |                                  | |  |---O-------|   |  |
| |                                  | |  +------------+   |  |
| |                                  | |  10               |  |
| |                                  | |                   |  |
| |                                  | |                   |  |
| |                                  | | [恢复默认] [保存] |  |
| +----------------------------------+ +-------------------+  |
|                                                             |
+-------------------------------------------------------------+
```

### 5.2 动画与过渡

- 主内容区通过CSS transform沿X轴平移
- 设置面板使用相同的变换机制滑入
- 过渡动画采用300ms持续时间和ease-in-out缓动函数
- 确保两个元素的动画同步进行

### 5.3 响应式行为

- **桌面端(>1024px)**：
  - 内容区域推移
  - 设置面板宽度380px

- **平板端(641px-1024px)**：
  - 内容区域推移
  - 设置面板宽度320px

- **移动端(<640px)**：
  - 设置面板覆盖全屏
  - 不执行推移动画
  - 提供明显的返回机制

### 5.4 Z-Index层级管理

为确保UI元素正确叠放，使用以下z-index层级：

- **侧边栏（左侧）**: z-index: 50（最高层级，确保在所有内容之上）
- **设置面板（右侧）**: z-index: 40
- **标题栏Header**: z-index: 30
- **主内容区域**: z-index: 20
- **背景遮罩层**: z-index: 10

此设计确保侧边栏和设置面板可以正常交互，且不会被其他元素遮挡。

### 5.5 视觉设计

- **半透明效果**：侧边栏和设置面板使用70%透明度背景，搭配8px模糊效果
- **边框分隔**：使用细边框分隔不同区域，增强视觉层次感
- **标题栏统一**：移除标题栏底部边框，与设置面板视觉上更加统一

## 6. 交互流程

1. **打开设置面板**：
   - 用户点击聊天界面顶部的设置图标
   - 主内容区向左推移
   - 设置面板从右侧滑入
   - 标题栏的设置图标变为关闭图标
   - 面板中显示当前对话的设置值

2. **调整设置**：
   - 用户可以选择不同的模型
   - 编辑或设置系统提示词
   - 调整保留的对话轮数

3. **保存设置**：
   - 点击"保存"按钮应用设置
   - 设置被保存到当前对话
   - 面板自动关闭
   - 主内容区恢复原位
   - 标题栏的关闭图标变回设置图标

4. **恢复默认**：
   - 点击"恢复默认"按钮
   - 设置重置为全局默认值
   - 需要点击"保存"才会应用

5. **取消设置**：
   - 点击标题栏中的关闭按钮
   - 面板滑出，主内容区恢复原位
   - 未保存的更改将被丢弃

## 7. 与其他组件的关系

### 7.1 与欢迎页面的关系

- 欢迎页面显示系统名称，但不显示聊天header
- 设置面板仅在有活动对话且有消息时才显示
- 欢迎页面左上角系统名称与header样式保持一致

### 7.2 与左侧侧边栏的关系

- 左侧侧边栏z-index高于header和设置面板，确保不被遮挡
- 侧边栏与设置面板可同时显示，不相互干扰
- 侧边栏使用透明效果，背景模糊处理，提升视觉体验

## 8. 后续改进方向

1. **高级设置选项**：
   - 添加模型参数调整(温度、最大长度等)
   - 支持更多自定义选项

2. **模板管理**：
   - 系统提示词模板库
   - 保存和重用常用设置组合

3. **预览功能**：
   - 实时预览设置变更的效果
   - 模型能力比较提示

4. **快捷操作**：
   - 键盘快捷键支持
   - 上下文菜单中的快速设置 